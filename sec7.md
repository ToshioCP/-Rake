### マルチタスクとテストタスク

ここでは、マルチタスクとテストタスクを説明します。

#### マルチタスク

ここでいう「マルチタスク」はRakeの「multitask」メソッドを使った処理のことで、一般に使う「マルチタスク」ではありません。
タスクの中には互いに影響を及ぼさないタスクが複数存在することがあります。
そのとき、それらをひとつのスレッドで順に実行するよりも、マルチスレッドにして並行処理するほうが高速です。
そのためのメソッドが「multitask」です。

例としてテキストファイル中の文字を「文字ごとに」カウントするプログラム`fre.rb`を用います。
`example/example8`フォルダにこのプログラムが入っていますが、そのソースリストの解説は省略します。
このプログラムは引数で与えられたファイルを捜査し、文字ごとの出現頻度を調べ、文字数と上位10位の文字とカウントを表示します。

```
$ ruby fre.rb ../../sec1.md
総文字数： 7828
頻度の上位10文字
"\n"   =>  409
" "    =>  262
"e"    =>  229
"`"    =>  217
"a"    =>  190
"の"    =>  162
"す"    =>  160
"を"    =>  142
"k"    =>  141
"で"    =>  126
```

これにより、総文字数は7828で、最も多く出現したのが改行で409個です。
改行や空白が上位に来ていて、あまり意味がないかもしれませんね。
もう少し先まで表示すれば日本語文字の頻度が分かり、より実用的かもしれません。
その場合は、ほんの少しプログラムを変えれば上位20位あるいは30位にできます。
あるいは、改行などの区切り文字を表示しないようにもできます。

当初の予想では、ある程度時間がかかると思っていたのですが、実行してみると一瞬で終わってしまいました。
マルチタスクのありがたさを実感するには、時間がかかるプログラムの方が良いのですが、更にもうひとつプログラムを書くのも面倒なので、これで説明します。
申し訳ありません。

さて、2つのRakefileを用意します。
`Rakefile1`と`Rakefile2`です。

Rakefile1

```ruby
require 'rake/clean'

files = FileList["../../sec*.md"]

task default: files

files.each do |f|
  task f do
    sh "ruby fre.rb #{f} > #{f.pathmap('%f').ext('txt')}"
  end
end

CLEAN.include files.pathmap('%f').ext('txt')
```

この`Rakefile1`は「sec1.md」から「sec7.md」までのファイルの文字出現頻度を調べ、その結果をファイルに書き出します。

`Rakefile2`もほぼ同様で、異なるのは出力ファイル名を違うものにしたことと、5行目の`task`メソッドを`multitask`メソッドをに代えたことです。

```ruby
multitask default: files
```

`multitask`メソッドではタスクを別々のスレッドで並行処理をしますので、速度上の効果が期待できます。
それを調べるためにRubyのBenchmarkライブラリを使って時間計測をしました。
プログラム`bm.rb`は次の通りです。

```ruby
require 'benchmark'

Benchmark.bm do |x|
  x.report {system "rake -f Rakefile1 -q"}
  x.report {system "rake -f Rakefile2 -q"}
end
```

ベンチマークライブラリの使い方は[Rubyのドキュメント](https://docs.ruby-lang.org/ja/3.0/library/benchmark.html)を参考にしてください。
実行してみます。

```
$ ruby bm.rb
       user     system      total        real
   0.000187   0.000033   0.569095 (  0.569198)
   0.000162   0.000029   0.959387 (  0.315929)
```

上がtaskメソッドで順にひとつひとつを処理した場合、下がmultitaskメソッドで並行処理をした場合です。
両者とも一瞬で終わってしまうので、体感的には変わらないのですが、上の結果をみるとmultitaskの方が1.8倍速くなっています。

マルチタスクが使えるためには、それぞれのタスクが干渉しないことが前提です。
タスクの組み立てを上手くして干渉しないようにすれば、multitaskメソッドで速度の改善が期待できます。

#### テストタスク

最後のトピックはテストタスクです。
現在のRubyの標準テストライブラリはminitestです。
minitestの情報はその[ホームページ](https://www.rubydoc.info/gems/minitest)にあります。
何回か経験すればテストのコツのようなものは分かると思います。

通常、テストのプログラムは`test`ディレクトリに集めておくことが多いです。
そのディレクトリにRakefileを置き、テストをマルチタスクで高速に行うことができます。
例が[Rubyのホームページ](https://docs.ruby-lang.org/ja/3.1/class/Rake=3a=3aTestTask.html)にありますので、参考にしてください。

ここで実例を作るのはかなり大きな作業になりますので、ここではRakefileとその解説のみにとどめます。

```ruby
require "rake/testtask"

Rake::TestTask.new do |t|
  t.libs << "test"
  t.test_files = FileList['test/test*.rb']
  t.verbose = true
end
```

この例では、テスト用のRubyファイルが「test」から始まるファイル名（通常は複数個のファイル）とします。

- `testtask`をrequireすることが必要です
- `Rake::TestTask.new`でテストタスクを生成します。
一般のタスクにはtaskメソッドがありますが、テストタスクはnewメソッドでインスタンスを作ります。
- ブロックの引数`t`は生成されたテストタスクです。
- `t.libs`はライブラリのロードパスで、`test`ディレクトリを追加します
- `test_files`メソッドで明示的にテストファイルを示します。
複数のファイルに含まれるテストのあいだにコンフリクトが起こらないようにしてください。
テストプログラムがファイルの読み書きをする場合は特に注意が必要です。
- `t.verbose=true`にすると、テストの実行結果の詳細を表示します。

コマンドラインから、testタスクを実行します。

```
$ rake test
```

#### おわりに

以上、Rakeの使い方について初心者向けに解説してきました。
最後は難しい内容になってしまったかと思いますが、前半だけ理解できればRakeは使えるようになります。
後半はある程度使えるようになってから、再学習しても良いと思います。

このチュートリアル自体もRakeを使ってマークダウンからHTMLを生成し、[Github Pages](https://toshiocp.github.io/Rake-tutorial-for-beginners-jp/%E3%81%AF%E3%81%98%E3%82%81%E3%81%A6%E3%81%AERake.html)に表示するようになっています。
トップディレクトリにあるRakefileも参考として見てください。

チュートリアルを最後までお読みいただき、ありがとうございました。

Happy Hacking!